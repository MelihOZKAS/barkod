<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium √úr√ºn Arama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #065f46 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .scroll-table {
            /* Scroll kaldƒ±rƒ±ldƒ± - tablo ekledik√ße uzasƒ±n */
        }
        .scroll-table::-webkit-scrollbar {
            width: 10px;
        }
        .scroll-table::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .scroll-table::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            border-radius: 10px;
        }
        .scroll-table::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #b45309 0%, #92400e 100%);
        }
        .btn-premium {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transition: all 0.3s;
        }
        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(217, 119, 6, 0.4);
        }
        .btn-success-premium {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        .btn-success-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.4);
        }
        .btn-danger-premium {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .btn-danger-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);
        }
    </style>
</head>
<body class="p-6">

{% if uyari %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        Swal.fire({
            icon: 'warning',
            title: 'Barkod Bulunamadƒ±!',
            html: '<p class="text-lg">Barkod <strong class="text-amber-600">{{ aranan_barkod }}</strong> sistemde kayƒ±tlƒ± deƒüil.</p>',
            confirmButtonText: 'Tamam',
            confirmButtonColor: '#d97706',
            timer: 3000,
            timerProgressBar: true,
            showClass: {
                popup: 'animate__animated animate__shakeX animate__faster'
            }
        });
    });
</script>
{% endif %}

<!-- Keyboard Shortcuts -->
<script>
    document.addEventListener('keydown', function (event) {
        if (event.key === 'F2') {
            window.location.href = '/modern-urun-ara/';
        } else if (event.key === 'F3') {
            window.location.href = '/modern-sepeti-sifirla/';
        } else if (event.key === 'F4') {
            window.location.href = '/musteri-listesi/';
        }
    });
</script>

<div class="max-w-[1600px] mx-auto">
    <!-- Header -->
    <div class="glass-effect rounded-3xl shadow-2xl p-8 mb-8">
        <div class="flex justify-between items-center flex-wrap gap-6">
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-amber-600 to-amber-800 bg-clip-text text-transparent">
                    {{ name }}
                </h1>
                <p class="text-gray-600 text-lg mt-1">{{ email }}</p>
            </div>
            <div class="flex gap-4 flex-wrap">
                <a href="{% url 'modern-urun-ara' %}" class="btn-premium text-white px-8 py-3 rounded-xl font-semibold text-lg shadow-lg">
                    üîç √úr√ºn Ara (F2)
                </a>
                <a href="{% url 'modern-sepeti-sifirla' %}" class="btn-danger-premium text-white px-8 py-3 rounded-xl font-semibold text-lg shadow-lg transition">
                    üóëÔ∏è Sepeti Sƒ±fƒ±rla (F3)
                </a>
                <a href="{% url 'musteri-listesi' %}" class="btn-success-premium text-white px-8 py-3 rounded-xl font-semibold text-lg shadow-lg transition">
                    üë• M√º≈üteri Listesi (F4)
                </a>
                <a href="{% url 'cikis-yap' %}" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-8 py-3 rounded-xl font-semibold text-lg shadow-lg transition">
                    üö™ √áƒ±kƒ±≈ü
                </a>
            </div>
        </div>
    </div>

    <!-- Son Eklenen √úr√ºn Bilgi √áubuƒüu -->
    {% if son_eklenen_urun %}
    <div class="glass-effect rounded-2xl shadow-lg p-6 mb-8 border-l-4 border-amber-500">
        <!-- ƒ∞lk Satƒ±r: Son Eklenen √úr√ºn -->
        <div class="flex justify-center items-center gap-8 flex-wrap mb-4">
            <div class="flex items-center gap-3">
                <span class="text-gray-600 font-semibold text-lg">üì¶ Son Eklenen:</span>
                <span class="text-gray-800 font-bold text-xl">{{ son_eklenen_urun.urun.Urun_Adi }}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-gray-600 font-semibold text-lg">üìÖ Son G√ºncelleme:</span>
                <span class="text-amber-600 font-bold text-xl">{{ son_eklenen_urun.urun.guncelleme_tarihi|date:"d/m/Y H:i" }}</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-gray-600 font-semibold text-lg">üí∞ Tutar:</span>
                <span class="text-emerald-600 font-bold text-2xl">{{ son_eklenen_urun.urun.Tutar }} TL</span>
            </div>
        </div>

        <!-- ƒ∞kinci Satƒ±r: Sepet ƒ∞statistikleri -->
        <div class="border-t border-gray-200 pt-4">
            <div class="flex justify-center items-center gap-8 flex-wrap">
                <div class="flex items-center gap-3">
                    <span class="text-gray-600 font-semibold text-lg">üõçÔ∏è Farklƒ± √úr√ºn:</span>
                    <span class="text-blue-600 font-bold text-2xl">{{ farkli_urun_sayisi }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-gray-600 font-semibold text-lg">üìä Toplam Adet:</span>
                    <span class="text-purple-600 font-bold text-2xl">{{ toplam_adet }}</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-gray-500 font-medium text-base">üí°</span>
                    <span class="text-gray-600 font-medium text-base italic">{{ farkli_urun_sayisi }} √ße≈üit √ºr√ºn, toplam {{ toplam_adet }} par√ßa</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <!-- Sepet B√∂l√ºm√º -->
        <div class="glass-effect rounded-3xl shadow-2xl p-8">
            <div class="mb-6">
                {% if total %}
                    <div class="flex items-center justify-center gap-4 flex-wrap">
                        <h2 class="text-3xl font-bold text-gray-800">
                            GENEL TOPLAM: <span class="text-emerald-600 text-4xl">{{ total }} TL</span>
                        </h2>
                        <button onclick="borcaAktarPopup()" class="bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white px-6 py-3 rounded-xl font-bold text-lg shadow-lg transition hover:shadow-xl hover:-translate-y-0.5">
                            üí≥ Bor√ßa Aktar
                        </button>
                    </div>
                {% else %}
                    <h2 class="text-3xl font-bold text-center text-gray-500">Sepette Hi√ß √úr√ºn Yok</h2>
                {% endif %}
            </div>

            <div class="scroll-table">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-amber-600 to-amber-700 text-white sticky top-0">
                        <tr>
                            <th class="px-6 py-4 text-left rounded-tl-2xl text-base">√úr√ºn Adƒ±</th>
                            <th class="px-6 py-4 text-center text-base">Adet</th>
                            <th class="px-6 py-4 text-center text-base">Toplam</th>
                            <th class="px-6 py-4 text-center text-base">Birim</th>
                            <th class="px-6 py-4 text-center rounded-tr-2xl text-base">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for urun in sepet_urunleri %}
                        <tr class="border-b hover:bg-amber-50 transition">
                            <td class="px-6 py-4">
                                <div class="font-semibold text-gray-800 text-base">{{ urun.urun.Urun_Adi }}</div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <select name="miktar" class="border-2 border-amber-300 rounded-lg px-3 py-2 focus:border-amber-500 focus:outline-none font-medium" data-urun-id="{{ urun.id }}">
                                    {% for i in Sayi %}
                                        {% if i == urun.miktar %}
                                            <option value="{{ i }}" selected>{{ i }}</option>
                                        {% else %}
                                            <option value="{{ i }}">{{ i }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-emerald-600 text-lg">{{ urun.toplam_fiyat }} TL</td>
                            <td class="px-6 py-4 text-center text-gray-600 font-medium">{{ urun.urun.Tutar }} TL</td>
                            <td class="px-6 py-4 text-center">
                                <form action="{% url 'modern-sepet-urun-sil' urun.id %}" method="POST" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-5 py-2 rounded-lg transition font-semibold shadow-md">
                                        Sil
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Arama ve Favoriler B√∂l√ºm√º -->
        <div class="glass-effect rounded-3xl shadow-2xl p-8">
            <!-- Arama Formu -->
            <form action="{% url 'modern-urun-ara' %}" method="POST" class="mb-8">
                {% csrf_token %}
                <div class="flex gap-3">
                    <input type="text" name="title" class="flex-1 border-2 border-amber-300 rounded-xl px-6 py-4 focus:border-amber-500 focus:outline-none text-lg font-medium" placeholder="Barkod / √úr√ºn Adƒ± Giriniz" autofocus>
                    <button type="submit" class="btn-premium text-white px-8 py-4 rounded-xl font-bold text-lg whitespace-nowrap shadow-lg">
                        üîç Ara
                    </button>
                </div>
            </form>

            <!-- Kategoriler -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-800">üìÇ Kategoriler</h3>
                <div class="flex flex-wrap gap-3">
                    {% for Kategori in AnaKategoriler %}
                    <button type="button" onclick="filtrele('{{ Kategori.Grup_Adi }}')" class="btn-success-premium text-white px-6 py-3 rounded-xl transition font-semibold shadow-md text-base">
                        {{ Kategori.Grup_Adi }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Favoriler -->
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-800">‚≠ê Favoriler</h3>
                <div class="flex flex-wrap gap-3">
                    {% for favori in Favoriler %}
                    <div class="favori" data-kategori="{{ favori.Liste_grup }}" style="display: none;">
                        <form action="{% url 'modern-sepete-ekle' %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="barkod" value="{{ favori.Barkod }}">
                            <button type="submit" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl transition font-semibold shadow-md">
                                {{ favori.Urun_Adi }}
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Manuel Tutar -->
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border-2 border-amber-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800 text-center">üí∞ Manuel Tutar Gir</h3>
                <form action="{% url 'modern-manuel-tutar' %}" method="POST">
                    {% csrf_token %}
                    <div class="space-y-3">
                        <input type="text" class="w-full border-2 border-amber-300 rounded-xl px-5 py-3 focus:border-amber-500 focus:outline-none font-medium" name="urun_ismi" placeholder="√úr√ºn ƒ∞smi (isteƒüe baƒülƒ±)">
                        <div class="flex gap-3">
                            <input type="number" step="0.01" min="0" class="flex-1 border-2 border-amber-300 rounded-xl px-5 py-3 focus:border-amber-500 focus:outline-none font-medium" name="tutar" placeholder="Tutar" required>
                            <button type="submit" class="btn-premium text-white px-8 py-3 rounded-xl font-bold whitespace-nowrap shadow-lg">
                                ‚ûï Ekle
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulunan √úr√ºnler -->
    <div class="glass-effect rounded-3xl shadow-2xl p-8 mt-8">
        <h3 class="text-3xl font-bold mb-6 text-gray-800">üîé Bulunan √úr√ºnler</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-amber-600 to-amber-700 text-white">
                    <tr>
                        <th class="px-6 py-4 text-left rounded-tl-2xl text-base">√úr√ºn Adƒ±</th>
                        <th class="px-6 py-4 text-center text-base">Barkod</th>
                        <th class="px-6 py-4 text-center text-base">Stok</th>
                        <th class="px-6 py-4 text-center text-base">Fiyat</th>
                        <th class="px-6 py-4 text-center rounded-tr-2xl text-base">ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody>
                    {% if results %}
                        {% for result in results %}
                        <tr class="border-b hover:bg-amber-50 transition">
                            <td class="px-6 py-4 font-semibold text-gray-800 text-base">{{ result.Urun_Adi }}</td>
                            <td class="px-6 py-4 text-center text-gray-600 font-medium">{{ result.Barkod }}</td>
                            <td class="px-6 py-4 text-center">
                                {% if result.Stok_Durumu %}
                                    <span class="bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md">‚úì Stokta</span>
                                {% else %}
                                    <span class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-md">‚úó Stokta Yok</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-emerald-600 text-lg">{{ result.Tutar }} TL</td>
                            <td class="px-6 py-4 text-center">
                                <form method="POST" action="{% url 'modern-sepete-ekle' %}" class="inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="barkod" value="{{ result.Barkod }}">
                                    <button type="submit" class="btn-premium text-white px-6 py-3 rounded-xl transition font-bold shadow-lg">
                                        üõí Sepete Ekle
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500 text-xl">
                                √úr√ºn Bulunamadƒ±
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500 text-xl">
                                Arama yapmak i√ßin barkod veya √ºr√ºn adƒ± giriniz
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Favori filtreleme
    function filtrele(kategori) {
        var favoriler = document.querySelectorAll('.favori');
        favoriler.forEach(function (favori) {
            if (favori.dataset.kategori === kategori) {
                favori.style.display = 'block';
            } else {
                favori.style.display = 'none';
            }
        });
    }

    // ============ BOR√áA AKTAR ============
    var sepetToplam = '{{ total|default:"0" }}';

    function borcaAktarPopup() {
        Swal.fire({
            title: 'üí≥ Bor√ßa Aktar',
            html: '<div id="borca-aktar-icerik" style="text-align:left;"></div>',
            showCancelButton: true,
            confirmButtonText: 'üí≥ Bor√ßa Aktar',
            cancelButtonText: 'ƒ∞ptal',
            confirmButtonColor: '#0d9488',
            cancelButtonColor: '#6b7280',
            width: '500px',
            didOpen: function() {
                borcaAktarIcerikOlustur();
                musterileriYukle();
            },
            preConfirm: function() {
                var secili = document.querySelector('input[name="swal-musteri"]:checked');
                var tutar = document.getElementById('swal-tutar').value;
                if (!secili) {
                    Swal.showValidationMessage('L√ºtfen bir m√º≈üteri se√ßin.');
                    return false;
                }
                if (!tutar || parseFloat(tutar) <= 0) {
                    Swal.showValidationMessage('Ge√ßerli bir tutar girin.');
                    return false;
                }
                return { musteri_id: secili.value, tutar: tutar };
            }
        }).then(function(result) {
            if (result.isConfirmed) {
                borcaAktarGonder(result.value.musteri_id, result.value.tutar);
            }
        });
    }

    function borcaAktarIcerikOlustur() {
        var container = document.getElementById('borca-aktar-icerik');
        container.textContent = '';

        // M√º≈üteri arama
        var araDiv = document.createElement('div');
        araDiv.style.marginBottom = '12px';
        var araInput = document.createElement('input');
        araInput.type = 'text';
        araInput.id = 'swal-musteri-ara';
        araInput.placeholder = 'M√º≈üteri Ara...';
        araInput.style.cssText = 'width:100%;padding:10px 14px;border:2px solid #d1d5db;border-radius:10px;font-size:15px;outline:none;';
        araInput.addEventListener('input', function() { musteriFiltrele(this.value); });
        araDiv.appendChild(araInput);
        container.appendChild(araDiv);

        // M√º≈üteri listesi container
        var listeDiv = document.createElement('div');
        listeDiv.id = 'swal-musteri-listesi';
        listeDiv.style.cssText = 'max-height:200px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:12px;';
        var yukleniyorDiv = document.createElement('div');
        yukleniyorDiv.style.cssText = 'text-align:center;padding:20px;color:#9ca3af;';
        yukleniyorDiv.textContent = 'Y√ºkleniyor...';
        listeDiv.appendChild(yukleniyorDiv);
        container.appendChild(listeDiv);

        // Yeni m√º≈üteri butonu
        var yeniDiv = document.createElement('div');
        yeniDiv.style.marginBottom = '12px';
        var yeniBtn = document.createElement('button');
        yeniBtn.type = 'button';
        yeniBtn.textContent = '+ Yeni M√º≈üteri Ekle';
        yeniBtn.style.cssText = 'width:100%;padding:10px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;';
        yeniBtn.addEventListener('click', yeniMusteriFormuGoster);
        yeniDiv.appendChild(yeniBtn);

        // Yeni m√º≈üteri formu (gizli)
        var formDiv = document.createElement('div');
        formDiv.id = 'yeni-musteri-form';
        formDiv.style.cssText = 'display:none;margin-top:8px;padding:12px;background:#f0f9ff;border-radius:10px;border:1px solid #bfdbfe;';
        var isimInput = document.createElement('input');
        isimInput.type = 'text';
        isimInput.id = 'yeni-musteri-isim';
        isimInput.placeholder = 'ƒ∞sim Soyisim';
        isimInput.style.cssText = 'width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;margin-bottom:6px;font-size:14px;';
        formDiv.appendChild(isimInput);
        var telInput = document.createElement('input');
        telInput.type = 'text';
        telInput.id = 'yeni-musteri-tel';
        telInput.placeholder = 'Telefon (isteƒüe baƒülƒ±)';
        telInput.style.cssText = 'width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;margin-bottom:8px;font-size:14px;';
        formDiv.appendChild(telInput);
        var kaydetBtn = document.createElement('button');
        kaydetBtn.type = 'button';
        kaydetBtn.textContent = 'Kaydet';
        kaydetBtn.style.cssText = 'width:100%;padding:8px;background:#059669;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;';
        kaydetBtn.addEventListener('click', yeniMusteriKaydet);
        formDiv.appendChild(kaydetBtn);
        yeniDiv.appendChild(formDiv);
        container.appendChild(yeniDiv);

        // Tutar b√∂l√ºm√º
        var tutarBolum = document.createElement('div');
        tutarBolum.style.cssText = 'border-top:1px solid #e5e7eb;padding-top:12px;';

        var radioDiv = document.createElement('div');
        radioDiv.style.cssText = 'display:flex;gap:12px;margin-bottom:8px;';
        // T√ºm√ºn√º Aktar
        var tamLabel = document.createElement('label');
        tamLabel.style.cssText = 'display:flex;align-items:center;gap:4px;cursor:pointer;font-weight:600;';
        var tamRadio = document.createElement('input');
        tamRadio.type = 'radio';
        tamRadio.name = 'swal-aktar-tip';
        tamRadio.value = 'tam';
        tamRadio.checked = true;
        tamRadio.addEventListener('change', aktarTipDegisti);
        tamLabel.appendChild(tamRadio);
        tamLabel.appendChild(document.createTextNode(' T√ºm√ºn√º Aktar'));
        radioDiv.appendChild(tamLabel);
        // Par√ßalƒ± Aktar
        var parcaliLabel = document.createElement('label');
        parcaliLabel.style.cssText = 'display:flex;align-items:center;gap:4px;cursor:pointer;font-weight:600;';
        var parcaliRadio = document.createElement('input');
        parcaliRadio.type = 'radio';
        parcaliRadio.name = 'swal-aktar-tip';
        parcaliRadio.value = 'parcali';
        parcaliRadio.addEventListener('change', aktarTipDegisti);
        parcaliLabel.appendChild(parcaliRadio);
        parcaliLabel.appendChild(document.createTextNode(' Par√ßalƒ± Aktar'));
        radioDiv.appendChild(parcaliLabel);
        tutarBolum.appendChild(radioDiv);

        var tutarRow = document.createElement('div');
        tutarRow.style.cssText = 'display:flex;align-items:center;gap:8px;';
        var tutarSpan = document.createElement('span');
        tutarSpan.style.cssText = 'font-weight:600;font-size:16px;';
        tutarSpan.textContent = 'Tutar:';
        tutarRow.appendChild(tutarSpan);
        var tutarInput = document.createElement('input');
        tutarInput.type = 'number';
        tutarInput.step = '0.01';
        tutarInput.min = '0.01';
        tutarInput.id = 'swal-tutar';
        tutarInput.value = sepetToplam;
        tutarInput.readOnly = true;
        tutarInput.style.cssText = 'flex:1;padding:10px 14px;border:2px solid #d1d5db;border-radius:10px;font-size:16px;font-weight:700;outline:none;';
        tutarRow.appendChild(tutarInput);
        var tlSpan = document.createElement('span');
        tlSpan.style.cssText = 'font-weight:700;font-size:16px;';
        tlSpan.textContent = 'TL';
        tutarRow.appendChild(tlSpan);
        tutarBolum.appendChild(tutarRow);
        container.appendChild(tutarBolum);
    }

    var tumMusteriler = [];

    function musterileriYukle() {
        $.get('/api/musteri-listesi/', function(data) {
            tumMusteriler = data.musteriler;
            musteriListesiRenderle(tumMusteriler);
        });
    }

    function musteriListesiRenderle(liste) {
        var container = document.getElementById('swal-musteri-listesi');
        container.textContent = '';
        if (liste.length === 0) {
            var bosDiv = document.createElement('div');
            bosDiv.style.cssText = 'text-align:center;padding:16px;color:#9ca3af;';
            bosDiv.textContent = 'M√º≈üteri bulunamadƒ±';
            container.appendChild(bosDiv);
            return;
        }
        for (var i = 0; i < liste.length; i++) {
            var m = liste[i];
            var label = document.createElement('label');
            label.style.cssText = 'display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background 0.15s;';
            label.addEventListener('mouseover', function() { this.style.background = '#f0fdfa'; });
            label.addEventListener('mouseout', function() { this.style.background = 'transparent'; });

            var radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'swal-musteri';
            radio.value = m.id;
            radio.style.marginRight = '10px';
            label.appendChild(radio);

            var infoDiv = document.createElement('div');
            infoDiv.style.flex = '1';
            var isimDiv = document.createElement('div');
            isimDiv.style.cssText = 'font-weight:600;color:#1f2937;';
            isimDiv.textContent = m.isim_soyisim;
            infoDiv.appendChild(isimDiv);
            if (m.Cep_Telefonu) {
                var telDiv = document.createElement('div');
                telDiv.style.cssText = 'font-size:12px;color:#6b7280;';
                telDiv.textContent = m.Cep_Telefonu;
                infoDiv.appendChild(telDiv);
            }
            label.appendChild(infoDiv);

            var borcDiv = document.createElement('div');
            borcDiv.style.cssText = 'font-weight:700;color:#dc2626;';
            borcDiv.textContent = 'Bor√ß: ' + m.borc + ' TL';
            label.appendChild(borcDiv);

            container.appendChild(label);
        }
    }

    function musteriFiltrele(q) {
        q = q.toLowerCase();
        var filtreli = tumMusteriler.filter(function(m) {
            return m.isim_soyisim.toLowerCase().indexOf(q) !== -1 || (m.Cep_Telefonu && m.Cep_Telefonu.indexOf(q) !== -1);
        });
        musteriListesiRenderle(filtreli);
    }

    function yeniMusteriFormuGoster() {
        var form = document.getElementById('yeni-musteri-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function yeniMusteriKaydet() {
        var isim = document.getElementById('yeni-musteri-isim').value.trim();
        var tel = document.getElementById('yeni-musteri-tel').value.trim();
        if (!isim) {
            Swal.showValidationMessage('M√º≈üteri ismi zorunludur.');
            return;
        }
        $.post('/api/hizli-musteri-ekle/', { isim_soyisim: isim, Cep_Telefonu: tel }, function(data) {
            if (data.success) {
                tumMusteriler.unshift(data.musteri);
                musteriListesiRenderle(tumMusteriler);
                document.getElementById('yeni-musteri-form').style.display = 'none';
                document.getElementById('yeni-musteri-isim').value = '';
                document.getElementById('yeni-musteri-tel').value = '';
                setTimeout(function() {
                    var radios = document.querySelectorAll('input[name="swal-musteri"]');
                    if (radios.length > 0) radios[0].checked = true;
                }, 100);
            } else {
                Swal.showValidationMessage(data.error);
            }
        });
    }

    function aktarTipDegisti() {
        var tip = document.querySelector('input[name="swal-aktar-tip"]:checked').value;
        var tutarInput = document.getElementById('swal-tutar');
        if (tip === 'tam') {
            tutarInput.value = sepetToplam;
            tutarInput.readOnly = true;
        } else {
            tutarInput.readOnly = false;
            tutarInput.value = '';
            tutarInput.focus();
        }
    }

    function borcaAktarGonder(musteri_id, tutar) {
        $.post('/api/borca-aktar/', { musteri_id: musteri_id, tutar: tutar }, function(data) {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Bor√ßa Aktarƒ±ldƒ±!',
                    html: '<b>' + escapeHtml(data.musteri_adi) + '</b> m√º≈üterisine <b>' + escapeHtml(tutar) + ' TL</b> bor√ß eklendi.<br>Yeni bor√ß: <b>' + escapeHtml(data.yeni_borc) + ' TL</b>',
                    confirmButtonText: 'Tamam',
                    confirmButtonColor: '#0d9488',
                }).then(function() {
                    window.location.href = '/modern-urun-ara/';
                });
            } else {
                Swal.fire({ icon: 'error', title: 'Hata!', text: data.error, confirmButtonColor: '#dc2626' });
            }
        }).fail(function() {
            Swal.fire({ icon: 'error', title: 'Hata!', text: 'Sunucu hatasƒ± olu≈ütu.', confirmButtonColor: '#dc2626' });
        });
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.textContent;
    }

    // Miktar g√ºncelleme
    $(document).ready(function () {
        $('select[name="miktar"]').on('change', function () {
            var miktar = $(this).val();
            var urun_id = $(this).data('urun-id');

            $.ajax({
                url: '/urun_miktar_guncelle/' + urun_id + '/',
                type: 'POST',
                data: {
                    miktar: miktar,
                },
                success: function (response) {
                    window.location.href = '/modern-urun-ara/';
                },
            });
        });
    });
</script>

</body>
</html>